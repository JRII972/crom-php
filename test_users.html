<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Utilisateurs</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Gestion des Utilisateurs</h1>

        <!-- Form for Adding/Editing Users -->
        <div class="bg-white p-6 rounded shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4" id="form-title">Ajouter un Utilisateur</h2>
            <form id="user-form" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" name="id" id="user-id">
                <input type="hidden" name="csrf_token" id="csrf-token" value="">
                <div>
                    <label for="prenom" class="block text-sm font-medium">Prénom *</label>
                    <input type="text" id="prenom" name="prenom" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="nom" class="block text-sm font-medium">Nom *</label>
                    <input type="text" id="nom" name="nom" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="login" class="block text-sm font-medium">Nom d'utilisateur (Login) *</label>
                    <input type="text" id="login" name="login" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="motDePasse" class="block text-sm font-medium">Mot de passe *</label>
                    <input type="password" id="motDePasse" name="motDePasse" required class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="sexe" class="block text-sm font-medium">Sexe *</label>
                    <select id="sexe" name="sexe" required class="w-full p-2 border rounded">
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium">Email</label>
                    <input type="email" id="email" name="email" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="dateDeNaissance" class="block text-sm font-medium">Date de naissance</label>
                    <input type="date" id="dateDeNaissance" name="dateDeNaissance" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="idDiscord" class="block text-sm font-medium">ID Discord</label>
                    <input type="text" id="idDiscord" name="idDiscord" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="pseudonyme" class="block text-sm font-medium">Pseudonyme</label>
                    <input type="text" id="pseudonyme" name="pseudonyme" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="image" class="block text-sm font-medium">Image</label>
                    <input type="file" id="image" name="image" accept="image/jpeg,image/png" class="w-full p-2 border rounded">
                    <img id="current-image" class="text-sm text-gray-500 mt-1" src=""/>
                </div>
                <div>
                    <label for="typeUtilisateur" class="block text-sm font-medium">Type d'utilisateur</label>
                    <select id="typeUtilisateur" name="typeUtilisateur" class="w-full p-2 border rounded">
                        <option value="NON_INSCRIT">Non Inscrit</option>
                        <option value="INSCRIT" selected>Inscrit</option>
                        <option value="ADMINISTRATEUR">Administrateur</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Ajouter</button>
                <button type="button" id="cancel-btn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 hidden">Annuler</button>
            </form>
            <p id="form-message" class="text-red-500 mt-2 hidden"></p>
        </div>

        <!-- User List -->
        <div class="bg-white p-6 rounded shadow-md">
            <h2 class="text-xl font-semibold mb-4">Liste des Utilisateurs</h2>
            <div id="user-list" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // Fetch CSRF token
        async function fetchCsrfToken() {
            const response = await fetch('/api/csrf_token.php');
            const data = await response.json();
            document.getElementById('csrf-token').value = data.csrf_token;
        }

        // Fetch and display users
        async function fetchUsers() {
            const response = await fetch('get_users.php');
            const users = await response.json();
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 border-b';
                div.innerHTML = `
                    <span>${user.prenom} ${user.nom} (${user.login}) - ${user.email || 'N/A'} ${user.image ? '<img src="' + user.image + '" class="inline w-8 h-8 object-cover" alt="User Image">' : ''}</span>
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600" data-id="${user.id}">Modifier</button>
                `;
                userList.appendChild(div);
            });
        }

        // Reset form to "add" mode
        function resetForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('form-title').textContent = 'Ajouter un Utilisateur';
            document.getElementById('submit-btn').textContent = 'Ajouter';
            document.getElementById('cancel-btn').classList.add('hidden');
            document.getElementById('form-message').classList.add('hidden');
            document.getElementById('current-image').textContent = '';
            document.getElementById('image').value = '';
        }

        // Populate form for editing
        async function populateForm(userId) {
            const response = await fetch(`get_user.php?id=${userId}`);
            const user = await response.json();
            console.log(user)
            document.getElementById('user-id').value = user.id;
            document.getElementById('prenom').value = user.prenom;
            document.getElementById('nom').value = user.nom;
            document.getElementById('login').value = user.nomUtilisateur;
            document.getElementById('motDePasse').value = '';
            document.getElementById('sexe').value = user.sexe;
            document.getElementById('email').value = user.email || '';
            document.getElementById('dateDeNaissance').value = user.dateDeNaissance || '';
            document.getElementById('idDiscord').value = user.idDiscord || '';
            document.getElementById('pseudonyme').value = user.pseudonyme || '';
            document.getElementById('typeUtilisateur').value = user.typeUtilisateur;
            user.image ? document.getElementById('current-image').setAttribute('src', user.image.url) : '';
            user.image ? document.getElementById('current-image').setAttribute('alt', user.image.imageAlt) : '';
            document.getElementById('image').value = '';
            document.getElementById('form-title').textContent = 'Modifier un Utilisateur';
            document.getElementById('submit-btn').textContent = 'Modifier';
            document.getElementById('cancel-btn').classList.remove('hidden');
        }

        // Handle form submission
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const userId = formData.get('id');
            const url = userId ? 'update_user.php' : 'create_user.php';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    resetForm();
                    fetchUsers();
                    document.getElementById('form-message').classList.add('hidden');
                } else {
                    document.getElementById('form-message').textContent = result.error || 'Une erreur est survenue.';
                    document.getElementById('form-message').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('form-message').textContent = 'Erreur de connexion au serveur.';
                document.getElementById('form-message').classList.remove('hidden');
            }
        });

        // Handle edit button clicks
        document.getElementById('user-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const userId = e.target.dataset.id;
                populateForm(userId);
            }
        });

        // Handle cancel button
        document.getElementById('cancel-btn').addEventListener('click', resetForm);

        // Initialize page
        fetchCsrfToken();
        fetchUsers();
    </script>
</body>
</html>